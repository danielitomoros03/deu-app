<%= form_with(model: [:dashboard, page], class: "form-container") do |form| %>
  <% if page.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <h5 class="alert-heading mb-2">
        <%= pluralize(page.errors.count, "error") %> impidieron guardar esta página:
      </h5>
      <ul class="mb-0">
        <% page.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white border-0 py-3">
      <h5 class="mb-0">
        <i class="fas fa-info-circle text-success me-2"></i>Información Básica
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Nombre -->
        <div class="col-md-12">
          <div class="form-group">
            <%= form.label :name, "Nombre de la Página", class: "form-label fw-bold text-dark mb-2" %>
            <%= form.text_field :name, class: "form-control form-control-lg", placeholder: "Ingrese el nombre de la página..." %>
            <small class="form-text text-muted">Este será el título principal de la página.</small>
          </div>
        </div>

        <!-- Descripción Corta -->
        <div class="col-md-12">
          <div class="form-group">
            <%= form.label :short_description, "Descripción Corta", class: "form-label fw-bold text-dark mb-2" %>
            <%= form.text_area :short_description, class: "form-control auto-grow", rows: 3, placeholder: "Ingrese una descripción breve de la página..." %>
            <small class="form-text text-muted">Esta descripción aparecerá en listados y resúmenes.</small>
          </div>
        </div>

        <!-- Descripción Larga -->
        <div class="col-md-12">
          <div class="form-group">
            <%= form.label :large_description, "Descripción Larga", class: "form-label fw-bold text-dark mb-2" %>
            <%= form.rich_text_area :large_description, class: "form-control trix-auto-height", placeholder: "Ingrese una descripción más detallada de la página..." %>
            <small class="form-text text-muted">Esta descripción aparecerá en la página principal.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white border-0 py-3">
      <h5 class="mb-0">
        <i class="fas fa-tags text-success me-2"></i>Clasificación
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Grupo -->
        <div class="col-md-6">
          <div class="form-group">
            <%= form.label :group, "Grupo", class: "form-label fw-bold text-dark mb-2" %>
            <%= form.select :group, 
                options_for_select(
                  allowed_groups_for_form(page),
                  page.group
                ), 
                { include_blank: "Seleccione un grupo..." }, 
                class: "form-select", 
                id: "page_group"
            %>
            <small class="form-text text-muted">Categoría principal de la página.</small>
          </div>
        </div>

        <!-- Subgrupo -->
        <div class="col-md-6">
          <div class="form-group">
            <%= form.label :subgroup, "Subgrupo", class: "form-label fw-bold text-dark mb-2" %>
            <%= form.select :subgroup, 
                options_for_select(
                  allowed_subgroups_for_group(page.group, page.subgroup),
                  page.subgroup
                ), 
                { include_blank: "Seleccione un subgrupo..." }, 
                class: "form-select", 
                id: "page_subgroup"
            %>
            <small class="form-text text-muted" id="subgroup-help">Subcategoría específica de la página.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <%= link_to dashboard_pages_path, class: "btn btn-outline-secondary" do %>
            <i class="fas fa-arrow-left me-2"></i>Volver al Listado
          <% end %>
        </div>
        <div class="d-flex gap-2">
          <% if page.persisted? %>
            <%= link_to dashboard_page_path(page), class: "btn btn-outline-success", title: "Ver página" do %>
              <i class="fas fa-eye me-2"></i>Ver
            <% end %>
          <% end %>
          
          <%= form.button type: "submit", class: "btn btn-success" do %>
            <i class="fas fa-save me-2"></i>
            <%= page.persisted? ? "Actualizar Página" : "Crear Página" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<style>
.form-container {
  max-width: 100%;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  font-size: 0.9rem;
}

.form-control, .form-select {
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 0.75rem 1rem;
  transition: all 0.2s ease-in-out;
}

/* Auto-grow textarea */
.auto-grow {
  overflow: hidden;
  resize: none;
  min-height: 3rem;
}

/* Trix editor sizing: give a reasonable minimum and allow it to grow */
trix-editor, .trix-content, .trix-editor[contenteditable] {
  min-height: 10rem;
  max-height: 80vh;
  overflow: auto;
}

.form-control:focus, .form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.1);
}

.form-control-lg {
  font-size: 1.1rem;
  font-weight: 500;
}

.form-text {
  font-size: 0.8rem;
  margin-top: 0.25rem;
}

.card {
  border-radius: 12px;
}

.card-header {
  border-bottom: 1px solid #f1f5f9;
}

.btn {
  border-radius: 8px;
  padding: 0.75rem 1.5rem;
  font-weight: 500;
  transition: all 0.2s ease-in-out;
}

.btn-primary {
  background-color: #01695b;
  border-color: #103a35ff;
}

.btn-primary:hover {
  background-color: #009a85ff;
  border-color: #01483fff;
  transform: translateY(-1px);
}

.btn-green-deu {
  background-color: #01695b;
  color: #ffffff;
}

.alert {
  border-radius: 12px;
  border: none;
}

.alert-danger {
  background-color: rgba(220, 53, 69, 0.1);
  color: #dc3545;
}

/* Estilos para selects deshabilitados */
.form-select:disabled {
  background-color: #f8f9fa;
  opacity: 0.6;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mapeo de subgrupos permitidos por grupo
  const subgroupMapping = {
    'inicio': ['title', 'view1', 'view2', 'view3'],
    'nosotros': ['title', 'description', 'value1', 'value2', 'value3', 'value4', 'functions', 'historical_review'],
    'programa2': ['title', 'description', 'objectives', 'functions', 'contact'],
    'programa3': ['title', 'description', 'objectives', 'functions', 'contact'],
    'departamento1': ['title', 'description', 'objectives', 'functions', 'contact'],
    'departamento2': ['title', 'description', 'objectives', 'functions', 'contact'],
    'departamento3': ['title', 'description', 'objectives', 'functions', 'contact'],
    'departamento4': ['title', 'description', 'objectives', 'functions', 'contact'],
    'grupos_extension': ['title', 'description', 'objectives', 'functions', 'contact'],
    'espacios_universitarios': ['title', 'description', 'objectives', 'functions', 'contact']
  };

  // Mensajes de ayuda por grupo
  const helpMessages = {
    'inicio': 'Subgrupos disponibles: Título, Vista 1, Vista 2, Vista 3',
    'nosotros': 'Subgrupos disponibles: Título, Descripción, Valores 1-4, Funciones, Reseña Histórica',
    'programa2': 'Subgrupos disponibles: Título, Descripción, Objetivos, Funciones, Contacto',
    'programa3': 'Subgrupos disponibles: Título, Descripción, Objetivos, Funciones, Contacto',
    'departamento1': 'Subgrupos disponibles: Título, Descripción, Objetivos, Funciones, Contacto',
    'departamento2': 'Subgrupos disponibles: Título, Descripción, Objetivos, Funciones, Contacto',
    'departamento3': 'Subgrupos disponibles: Título, Descripción, Objetivos, Funciones, Contacto',
    'departamento4': 'Subgrupos disponibles: Título, Descripción, Objetivos, Funciones, Contacto',
    'grupos_extension': 'Subgrupos disponibles: Título, Descripción, Objetivos, Funciones, Contacto',
    'espacios_universitarios': 'Subgrupos disponibles: Título, Descripción, Objetivos, Funciones, Contacto'
  };

  const groupSelect = document.getElementById('page_group');
  const subgroupSelect = document.getElementById('page_subgroup');
  const subgroupHelp = document.getElementById('subgroup-help');

  // Función para actualizar los subgrupos disponibles
  function updateSubgroups() {
    const selectedGroup = groupSelect.value;
    const currentSubgroup = subgroupSelect.value;
    
    // Limpiar opciones actuales
    subgroupSelect.innerHTML = '<option value="">Seleccione un subgrupo...</option>';
    
    if (selectedGroup && subgroupMapping[selectedGroup]) {
      // Habilitar el select de subgrupos
      subgroupSelect.disabled = false;
      
      // Agregar opciones permitidas
      subgroupMapping[selectedGroup].forEach(subgroup => {
        const option = document.createElement('option');
        option.value = subgroup;
        option.textContent = subgroup.charAt(0).toUpperCase() + subgroup.slice(1).replace(/([A-Z])/g, ' $1');
        option.selected = (subgroup === currentSubgroup);
        subgroupSelect.appendChild(option);
      });
      
      // Actualizar mensaje de ayuda
      subgroupHelp.textContent = helpMessages[selectedGroup];
      subgroupSelect.style.backgroundColor = '#f8f9fa';
    } else {
      // Deshabilitar si no hay grupo seleccionado
      subgroupSelect.disabled = true;
      subgroupSelect.style.backgroundColor = '';
      subgroupHelp.textContent = 'Seleccione un grupo primero para ver los subgrupos disponibles.';
    }
  }

  // Inicializar y agregar event listener
  if (groupSelect && subgroupSelect) {
    updateSubgroups(); // Inicializar con el estado actual
    groupSelect.addEventListener('change', updateSubgroups);
    
    // Aplicar estilos iniciales a los selects con valor
    if (groupSelect.value) {
      groupSelect.style.backgroundColor = '#f8f9fa';
    }
    if (subgroupSelect.value && !subgroupSelect.disabled) {
      subgroupSelect.style.backgroundColor = '#f8f9fa';
    }
  }
});

// Auto-resize for textareas with class 'auto-grow'
function autoResizeTextareas() {
  const areas = document.querySelectorAll('textarea.auto-grow');
  areas.forEach(area => {
    const resize = () => {
      area.style.height = 'auto';
      area.style.height = (area.scrollHeight) + 'px';
    };
    // Initialize size
    resize();
    // Attach listener
    area.addEventListener('input', resize);
    // Also adjust on window resize
    window.addEventListener('resize', resize);
  });
}

document.addEventListener('DOMContentLoaded', autoResizeTextareas);

// If Trix is present, ensure its editor area doesn't collapse visually.
document.addEventListener('trix-initialize', function(event) {
  const editor = event.target;
  // ensure min-height is applied (CSS handles most of it); force a layout recalculation
  editor.style.minHeight = editor.style.minHeight || '10rem';
});
</script>